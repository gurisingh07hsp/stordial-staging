// Indian cities with their coordinates
export const indianCities = [
  { name: 'Mumbai', latitude: 19.0760, longitude: 72.8777 },
  { name: 'Delhi', latitude: 28.7041, longitude: 77.1025 },
  { name: 'Bangalore', latitude: 12.9716, longitude: 77.5946 },
  { name: 'Hyderabad', latitude: 17.3850, longitude: 78.4867 },
  { name: 'Chennai', latitude: 13.0827, longitude: 80.2707 },
  { name: 'Kolkata', latitude: 22.5726, longitude: 88.3639 },
  { name: 'Pune', latitude: 18.5204, longitude: 73.8567 },
  { name: 'Ahmedabad', latitude: 23.0225, longitude: 72.5714 },
  { name: 'Jaipur', latitude: 26.9124, longitude: 75.7873 },
  { name: 'Surat', latitude: 21.1702, longitude: 72.8311 },
  { name: 'Lucknow', latitude: 26.8467, longitude: 80.9462 },
  { name: 'Kanpur', latitude: 26.4499, longitude: 80.3319 },
  { name: 'Nagpur', latitude: 21.1458, longitude: 79.0882 },
  { name: 'Indore', latitude: 22.7196, longitude: 75.8577 },
  { name: 'Thane', latitude: 19.2183, longitude: 72.9781 },
  { name: 'Bhopal', latitude: 23.2599, longitude: 77.4126 },
  { name: 'Visakhapatnam', latitude: 17.6868, longitude: 83.2185 },
  { name: 'Pimpri-Chinchwad', latitude: 18.6298, longitude: 73.7997 },
  { name: 'Patna', latitude: 25.5941, longitude: 85.1376 },
  { name: 'Vadodara', latitude: 22.3072, longitude: 73.1812 },
  { name: 'Ghaziabad', latitude: 28.6692, longitude: 77.4538 },
  { name: 'Ludhiana', latitude: 30.9010, longitude: 75.8573 },
  { name: 'Agra', latitude: 27.1767, longitude: 78.0081 },
  { name: 'Nashik', latitude: 19.9975, longitude: 73.7898 },
  { name: 'Faridabad', latitude: 28.4089, longitude: 77.3178 },
  { name: 'Meerut', latitude: 28.9845, longitude: 77.7064 },
  { name: 'Rajkot', latitude: 22.3039, longitude: 70.8022 },
  { name: 'Kalyan-Dombivali', latitude: 19.2350, longitude: 73.1299 },
  { name: 'Vasai-Virar', latitude: 19.4259, longitude: 72.8225 },
  { name: 'Varanasi', latitude: 25.3176, longitude: 82.9739 },
  { name: 'Srinagar', latitude: 34.0837, longitude: 74.7973 },
  { name: 'Aurangabad', latitude: 19.8762, longitude: 75.3433 },
  { name: 'Dhanbad', latitude: 23.7944, longitude: 86.4304 },
  { name: 'Amritsar', latitude: 31.6340, longitude: 74.8723 },
  { name: 'Allahabad', latitude: 25.4358, longitude: 81.8463 },
  { name: 'Ranchi', latitude: 23.6102, longitude: 85.2799 },
  { name: 'Howrah', latitude: 22.5958, longitude: 88.2636 },
  { name: 'Coimbatore', latitude: 11.0168, longitude: 76.9558 },
  { name: 'Jabalpur', latitude: 23.1815, longitude: 79.9864 },
  { name: 'Gwalior', latitude: 26.2183, longitude: 78.1828 },
  { name: 'Vijayawada', latitude: 16.5062, longitude: 80.6480 },
  { name: 'Jodhpur', latitude: 26.2389, longitude: 73.0243 },
  { name: 'Madurai', latitude: 9.9252, longitude: 78.1198 },
  { name: 'Raipur', latitude: 21.2514, longitude: 81.6296 },
  { name: 'Kota', latitude: 25.2138, longitude: 75.8648 },
  { name: 'Guwahati', latitude: 26.1445, longitude: 91.7362 },
  { name: 'Chandigarh', latitude: 30.7333, longitude: 76.7794 },
  { name: 'Solapur', latitude: 17.6599, longitude: 75.9064 },
  { name: 'Hubli-Dharwad', latitude: 15.3647, longitude: 75.1240 },
  { name: 'Bareilly', latitude: 28.3670, longitude: 79.4304 },
  { name: 'Moradabad', latitude: 28.8389, longitude: 78.7738 },
  { name: 'Mysore', latitude: 12.2958, longitude: 76.6394 },
  { name: 'Gurgaon', latitude: 28.4595, longitude: 77.0266 },
  { name: 'Aligarh', latitude: 27.8974, longitude: 78.0880 },
  { name: 'Jalandhar', latitude: 31.3260, longitude: 75.5762 },
  { name: 'Tiruchirappalli', latitude: 10.7905, longitude: 78.7047 },
  { name: 'Bhubaneswar', latitude: 20.2961, longitude: 85.8245 },
  { name: 'Salem', latitude: 11.6643, longitude: 78.1460 },
  { name: 'Warangal', latitude: 17.9689, longitude: 79.5941 },
  { name: 'Guntur', latitude: 16.2991, longitude: 80.4575 },
  { name: 'Bhiwandi', latitude: 19.2969, longitude: 73.0629 },
  { name: 'Saharanpur', latitude: 29.9675, longitude: 77.5451 },
  { name: 'Gorakhpur', latitude: 26.7606, longitude: 83.3732 },
  { name: 'Bikaner', latitude: 28.0229, longitude: 73.3119 },
  { name: 'Amravati', latitude: 20.9320, longitude: 77.7523 },
  { name: 'Noida', latitude: 28.5355, longitude: 77.3910 },
  { name: 'Jamshedpur', latitude: 22.8046, longitude: 86.2029 },
  { name: 'Bhilai', latitude: 21.2094, longitude: 81.4285 },
  { name: 'Cuttack', latitude: 20.4625, longitude: 85.8830 },
  { name: 'Firozabad', latitude: 27.1591, longitude: 78.3958 },
  { name: 'Kochi', latitude: 9.9312, longitude: 76.2673 },
  { name: 'Nellore', latitude: 14.4426, longitude: 79.9864 },
  { name: 'Bhavnagar', latitude: 21.7645, longitude: 72.1519 },
  { name: 'Dehradun', latitude: 30.3165, longitude: 78.0322 },
  { name: 'Durgapur', latitude: 23.5204, longitude: 87.3119 },
  { name: 'Asansol', latitude: 23.6889, longitude: 86.9661 },
  { name: 'Rourkela', latitude: 22.2492, longitude: 84.8828 },
  { name: 'Nanded', latitude: 19.1383, longitude: 77.3210 },
  { name: 'Kolhapur', latitude: 16.7050, longitude: 74.2433 },
  { name: 'Ajmer', latitude: 26.4499, longitude: 74.6399 },
  { name: 'Akola', latitude: 20.7074, longitude: 77.0026 },
  { name: 'Gulbarga', latitude: 17.3297, longitude: 76.8343 },
  { name: 'Jamnagar', latitude: 22.4707, longitude: 70.0577 },
  { name: 'Ujjain', latitude: 23.1765, longitude: 75.7885 },
  { name: 'Loni', latitude: 28.7515, longitude: 77.2885 },
  { name: 'Siliguri', latitude: 26.7271, longitude: 88.3953 },
  { name: 'Jhansi', latitude: 25.4484, longitude: 78.5685 },
  { name: 'Ulhasnagar', latitude: 19.2183, longitude: 73.1634 },
  { name: 'Jammu', latitude: 32.7266, longitude: 74.8570 },
  { name: 'Sangli-Miraj', latitude: 16.8524, longitude: 74.5815 },
  { name: 'Mangalore', latitude: 12.9141, longitude: 74.8560 },
  { name: 'Erode', latitude: 11.3410, longitude: 77.7172 },
  { name: 'Belgaum', latitude: 15.8497, longitude: 74.4977 },
  { name: 'Ambattur', latitude: 13.0982, longitude: 80.1614 },
  { name: 'Tirunelveli', latitude: 8.7139, longitude: 77.7567 },
  { name: 'Malegaon', latitude: 20.5598, longitude: 74.5254 },
  { name: 'Gaya', latitude: 24.7914, longitude: 85.0002 },
  { name: 'Jalgaon', latitude: 21.0077, longitude: 75.5626 },
  { name: 'Udaipur', latitude: 24.5854, longitude: 73.7125 },
  { name: 'Maheshtala', latitude: 22.5086, longitude: 88.2532 },
  { name: 'Tirupur', latitude: 11.1085, longitude: 77.3411 },
  { name: 'Davanagere', latitude: 14.4644, longitude: 75.9218 },
  { name: 'Kozhikode', latitude: 11.2588, longitude: 75.7804 },
  { name: 'Kurnool', latitude: 15.8281, longitude: 78.0373 },
  { name: 'Rajpur Sonarpur', latitude: 22.4491, longitude: 88.3915 },
  { name: 'Bokaro Steel City', latitude: 23.6693, longitude: 86.1511 },
  { name: 'South Dumdum', latitude: 22.6100, longitude: 88.4000 },
  { name: 'Bellary', latitude: 15.1398, longitude: 76.9214 },
  { name: 'Patiala', latitude: 30.3398, longitude: 76.3869 },
  { name: 'Gopalpur', latitude: 19.2599, longitude: 84.9053 },
  { name: 'Agartala', latitude: 23.8315, longitude: 91.2868 },
  { name: 'Bhagalpur', latitude: 25.2445, longitude: 87.0088 },
  { name: 'Muzaffarnagar', latitude: 29.4709, longitude: 77.7033 },
  { name: 'Bhatpara', latitude: 22.8664, longitude: 88.4013 },
  { name: 'Panihati', latitude: 22.6949, longitude: 88.3744 },
  { name: 'Latur', latitude: 18.4088, longitude: 76.5604 },
  { name: 'Dhule', latitude: 20.9024, longitude: 74.7733 },
  { name: 'Rohtak', latitude: 28.8955, longitude: 76.6066 },
  { name: 'Korba', latitude: 22.3459, longitude: 82.6963 },
  { name: 'Bhilwara', latitude: 25.3463, longitude: 74.6364 },
  { name: 'Berhampur', latitude: 19.3149, longitude: 84.7941 },
  { name: 'Muzaffarpur', latitude: 26.1209, longitude: 85.3647 },
  { name: 'Ahmednagar', latitude: 19.0952, longitude: 74.7496 },
  { name: 'Mathura', latitude: 27.4924, longitude: 77.6737 },
  { name: 'Kollam', latitude: 8.8932, longitude: 76.6141 },
  { name: 'Avadi', latitude: 13.1147, longitude: 80.0998 },
  { name: 'Kadapa', latitude: 14.4753, longitude: 78.8354 },
  { name: 'Kamarhati', latitude: 22.6711, longitude: 88.3745 },
  { name: 'Bilaspur', latitude: 22.0796, longitude: 82.1391 },
  { name: 'Shahjahanpur', latitude: 27.8830, longitude: 79.9055 },
  { name: 'Satara', latitude: 17.6868, longitude: 74.0069 },
  { name: 'Bijapur', latitude: 16.8244, longitude: 75.7154 },
  { name: 'Rampur', latitude: 28.8154, longitude: 79.0252 },
  { name: 'Shivamogga', latitude: 13.9299, longitude: 75.5681 },
  { name: 'Chandrapur', latitude: 19.9615, longitude: 79.2961 },
  { name: 'Junagadh', latitude: 21.5222, longitude: 70.4579 },
  { name: 'Thrissur', latitude: 10.5276, longitude: 76.2144 },
  { name: 'Alwar', latitude: 27.5665, longitude: 76.6108 },
  { name: 'Bardhaman', latitude: 23.2324, longitude: 87.8565 },
  { name: 'Kulti', latitude: 23.7317, longitude: 86.8437 },
  { name: 'Kakinada', latitude: 16.9891, longitude: 82.2475 },
  { name: 'Nizamabad', latitude: 18.6715, longitude: 78.0948 },
  { name: 'Parbhani', latitude: 19.2487, longitude: 76.4979 },
  { name: 'Tumkur', latitude: 13.3409, longitude: 77.1025 },
  { name: 'Hisar', latitude: 29.1492, longitude: 75.7217 },
  { name: 'Ozhukarai', latitude: 11.9483, longitude: 79.7639 },
  { name: 'Bihar Sharif', latitude: 25.1961, longitude: 85.5239 },
  { name: 'Panipat', latitude: 29.3909, longitude: 76.9635 },
  { name: 'Darbhanga', latitude: 26.1526, longitude: 85.8972 },
  { name: 'Bally', latitude: 22.6500, longitude: 88.3400 },
  { name: 'Aizawl', latitude: 23.7307, longitude: 92.7173 },
  { name: 'Dewas', latitude: 22.9663, longitude: 76.0661 },
  { name: 'Ichalkaranji', latitude: 16.6915, longitude: 74.4605 },
  { name: 'Tirupati', latitude: 13.6288, longitude: 79.4192 },
  { name: 'Karnal', latitude: 29.6857, longitude: 76.9905 },
  { name: 'Bathinda', latitude: 30.2070, longitude: 74.9455 }
];

// Calculate distance between two points using Haversine formula
function calculateDistance(lat1: number, lon1: number, lat2: number, lon2: number): number {
  const R = 6371; // Earth's radius in kilometers
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = 
    Math.sin(dLat/2) * Math.sin(dLat/2) +
    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
    Math.sin(dLon/2) * Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

// Find the nearest Indian city to given coordinates
export function findNearestIndianCity(latitude: number, longitude: number): { name: string; distance: number } {
  let nearestCity = indianCities[0];
  let minDistance = calculateDistance(latitude, longitude, nearestCity.latitude, nearestCity.longitude);
  
  for (const city of indianCities) {
    const distance = calculateDistance(latitude, longitude, city.latitude, city.longitude);
    if (distance < minDistance) {
      minDistance = distance;
      nearestCity = city;
    }
  }
  
  return {
    name: nearestCity.name,
    distance: minDistance
  };
}

// Get user location using browser's Geolocation API with automatic permission handling
export function getUserLocation(): Promise<{ latitude: number; longitude: number }> {
  return new Promise((resolve, reject) => {
    if (!navigator.geolocation) {
      reject(new Error('Geolocation is not supported by this browser.'));
      return;
    }

    // Try to get location with automatic permission request
    navigator.geolocation.getCurrentPosition(
      (position) => {
        resolve({
          latitude: position.coords.latitude,
          longitude: position.coords.longitude
        });
      },
      (error) => {
        // If permission denied, try again with different settings
        if (error.code === error.PERMISSION_DENIED) {
          // Try again with lower accuracy and longer timeout
          navigator.geolocation.getCurrentPosition(
            (position) => {
              resolve({
                latitude: position.coords.latitude,
                longitude: position.coords.longitude
              });
            },
            (secondError) => {
              // If still denied, try one more time with minimal settings
              navigator.geolocation.getCurrentPosition(
                (position) => {
                  resolve({
                    latitude: position.coords.latitude,
                    longitude: position.coords.longitude
                  });
                },
                (thirdError) => {
                  // If all attempts fail, use default location
                  console.log('Location permission denied, using default location');
                  resolve({
                    latitude: 19.0760, // Mumbai coordinates
                    longitude: 72.8777
                  });
                },
                {
                  enableHighAccuracy: false,
                  timeout: 15000,
                  maximumAge: 600000 // 10 minutes
                }
              );
            },
            {
              enableHighAccuracy: false,
              timeout: 10000,
              maximumAge: 300000 // 5 minutes
            }
          );
        } else {
          // For other errors, use default location
          console.log('Location error, using default location');
          resolve({
            latitude: 19.0760, // Mumbai coordinates
            longitude: 72.8777
          });
        }
      },
      {
        enableHighAccuracy: true,
        timeout: 8000,
        maximumAge: 300000 // 5 minutes
      }
    );
  });
}

// Auto-detect location without user interaction - like browser popup
export function autoDetectLocation(): Promise<{ 
  latitude: number; 
  longitude: number; 
  nearestCity: string; 
  distance: number 
}> {
  return new Promise((resolve) => {
    // Try to get location immediately with automatic permission request
    getUserLocation()
      .then((coords) => {
        const nearestCity = findNearestIndianCity(coords.latitude, coords.longitude);
        resolve({
          latitude: coords.latitude,
          longitude: coords.longitude,
          nearestCity: nearestCity.name,
          distance: nearestCity.distance
        });
      })
      .catch(() => {
        // If failed, resolve with Mumbai as default
        resolve({
          latitude: 19.0760,
          longitude: 72.8777,
          nearestCity: 'Mumbai',
          distance: 0
        });
      });
  });
} 